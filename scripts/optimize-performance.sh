#!/bin/bash

# Chat History Manager - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# .mdcãƒ«ãƒ¼ãƒ«æº–æ‹ : æ®µéšŽçš„æœ€é©åŒ–ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

set -e

echo "ðŸš€ Chat History Manager - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–ã‚’é–‹å§‹ã—ã¾ã™"

# è‰²ä»˜ããƒ­ã‚°é–¢æ•°
log_info() {
    echo -e "\033[32m[INFO]\033[0m $1"
}

log_warn() {
    echo -e "\033[33m[WARN]\033[0m $1"
}

log_error() {
    echo -e "\033[31m[ERROR]\033[0m $1"
}

# 1. TypeScriptãƒ“ãƒ«ãƒ‰æœ€é©åŒ–
log_info "Phase 1: TypeScriptãƒ“ãƒ«ãƒ‰æœ€é©åŒ–"
echo "ðŸ“¦ TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«è¨­å®šã‚’æœ€é©åŒ–ä¸­..."

# tsconfig.jsonã®æœ€é©åŒ–è¨­å®šã‚’ç¢ºèª
if [ -f "tsconfig.json" ]; then
    log_info "âœ… tsconfig.json ãŒå­˜åœ¨ã—ã¾ã™"
    
    # ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ãƒ“ãƒ«ãƒ‰ã®æœ‰åŠ¹åŒ–ç¢ºèª
    if grep -q '"incremental": true' tsconfig.json; then
        log_info "âœ… ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ãƒ“ãƒ«ãƒ‰ãŒæœ‰åŠ¹ã§ã™"
    else
        log_warn "âš ï¸ ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ãƒ“ãƒ«ãƒ‰ãŒç„¡åŠ¹ã§ã™"
    fi
else
    log_error "âŒ tsconfig.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    exit 1
fi

# 2. ä¾å­˜é–¢ä¿‚ã®æœ€é©åŒ–
log_info "Phase 2: ä¾å­˜é–¢ä¿‚ã®æœ€é©åŒ–"
echo "ðŸ“‹ package.json ã®ä¾å­˜é–¢ä¿‚ã‚’åˆ†æžä¸­..."

# æœªä½¿ç”¨ä¾å­˜é–¢ä¿‚ã®ãƒã‚§ãƒƒã‚¯
if command -v npx &> /dev/null; then
    log_info "ðŸ” æœªä½¿ç”¨ä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
    # npx depcheck --skip-missing || log_warn "âš ï¸ æœªä½¿ç”¨ä¾å­˜é–¢ä¿‚ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
else
    log_warn "âš ï¸ npx ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"
fi

# 3. ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚ºã®æœ€é©åŒ–
log_info "Phase 3: ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚ºã®æœ€é©åŒ–"

# distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚µã‚¤ã‚ºç¢ºèª
if [ -d "dist" ]; then
    DIST_SIZE=$(du -sh dist | cut -f1)
    log_info "ðŸ“Š ç¾åœ¨ã®ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚º: $DIST_SIZE"
else
    log_warn "âš ï¸ distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
fi

# 4. ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–
log_info "Phase 4: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–"

# Node.jsãƒ¡ãƒ¢ãƒªè¨­å®šã®ç¢ºèª
if [ -f "package.json" ]; then
    if grep -q "max-old-space-size" package.json; then
        log_info "âœ… Node.jsãƒ¡ãƒ¢ãƒªè¨­å®šãŒæœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™"
    else
        log_warn "âš ï¸ Node.jsãƒ¡ãƒ¢ãƒªè¨­å®šã®æœ€é©åŒ–ã‚’æŽ¨å¥¨ã—ã¾ã™"
        echo "  æŽ¨å¥¨è¨­å®š: --max-old-space-size=4096"
    fi
fi

# 5. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®æœ€é©åŒ–
log_info "Phase 5: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®æœ€é©åŒ–"

# .gitignoreã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
if [ -f ".gitignore" ]; then
    if grep -q "node_modules" .gitignore && grep -q "dist" .gitignore; then
        log_info "âœ… åŸºæœ¬çš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šãŒé©åˆ‡ã§ã™"
    else
        log_warn "âš ï¸ .gitignoreã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
    fi
fi

# 6. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–
log_info "Phase 6: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–"

# logsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚µã‚¤ã‚ºç¢ºèª
if [ -d "logs" ]; then
    LOGS_SIZE=$(du -sh logs | cut -f1)
    log_info "ðŸ“Š ç¾åœ¨ã®ãƒ­ã‚°ã‚µã‚¤ã‚º: $LOGS_SIZE"
    
    # å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    find logs -name "*.log" -mtime +7 -type f | while read file; do
        log_info "ðŸ—‘ï¸ å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤: $file"
        rm -f "$file"
    done
else
    log_info "ðŸ“ logsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™"
    mkdir -p logs
fi

# 7. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
log_info "Phase 7: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœ€é©åŒ–"

# dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚µã‚¤ã‚ºç¢ºèª
if [ -d "data" ]; then
    DATA_SIZE=$(du -sh data | cut -f1)
    log_info "ðŸ“Š ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: $DATA_SIZE"
else
    log_info "ðŸ“ dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™"
    mkdir -p data
fi

# 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
log_info "Phase 8: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ"

# ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚é–“ã‚’æ¸¬å®š
if [ -f "package.json" ] && grep -q '"test"' package.json; then
    log_info "ðŸ§ª ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
    
    START_TIME=$(date +%s)
    npm test > /dev/null 2>&1 || log_warn "âš ï¸ ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
    END_TIME=$(date +%s)
    
    DURATION=$((END_TIME - START_TIME))
    log_info "â±ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“: ${DURATION}ç§’"
    
    if [ $DURATION -lt 30 ]; then
        log_info "âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã¯è‰¯å¥½ã§ã™"
    elif [ $DURATION -lt 60 ]; then
        log_warn "âš ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ãŒã‚„ã‚„é•·ã„ã§ã™"
    else
        log_warn "âš ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ã®æœ€é©åŒ–ã‚’æŽ¨å¥¨ã—ã¾ã™"
    fi
fi

# 9. æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
log_info "Phase 9: æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ"

REPORT_FILE="performance-report-$(date +%Y%m%d-%H%M%S).md"

cat > "$REPORT_FILE" << EOF
# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆ

**å®Ÿè¡Œæ—¥æ™‚**: $(date)
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: Chat History Manager

## ðŸ“Š ç¾åœ¨ã®çŠ¶æ³

### ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚º
- **dist**: ${DIST_SIZE:-"æœªæ¸¬å®š"}
- **logs**: ${LOGS_SIZE:-"æœªæ¸¬å®š"}
- **data**: ${DATA_SIZE:-"æœªæ¸¬å®š"}

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æŒ‡æ¨™
- **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“**: ${DURATION:-"æœªæ¸¬å®š"}ç§’
- **TypeScript**: åŽ³æ ¼ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹
- **ESLint**: è¨­å®šæ¸ˆã¿

## ðŸŽ¯ æŽ¨å¥¨æ”¹å–„ç‚¹

1. **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®ç›£è¦–**
   - Node.jsãƒ’ãƒ¼ãƒ—ã‚µã‚¤ã‚ºã®æœ€é©åŒ–
   - ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®èª¿æ•´

2. **ãƒ“ãƒ«ãƒ‰æ™‚é–“ã®çŸ­ç¸®**
   - ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ãƒ“ãƒ«ãƒ‰ã®æ´»ç”¨
   - ä¸¦åˆ—å‡¦ç†ã®æœ€é©åŒ–

3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**
   - ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ€é©åŒ–
   - CDNæ´»ç”¨ã®æ¤œè¨Ž

## ðŸ“ˆ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- [ ] ãƒ¡ãƒ¢ãƒªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã®å®Ÿè¡Œ
- [ ] ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½
- [ ] ç¶™ç¶šçš„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›£è¦–ã®è¨­å®š

---
**ç”Ÿæˆè€…**: optimize-performance.sh
**æ¬¡å›žå®Ÿè¡Œäºˆå®š**: $(date -d '+1 week')
EOF

log_info "ðŸ“„ æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: $REPORT_FILE"

# 10. æœ€çµ‚ç¢ºèªã¨ã‚µãƒžãƒªãƒ¼
log_info "Phase 10: æœ€é©åŒ–å®Œäº†"

echo ""
echo "ðŸŽ‰ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo ""
echo "ðŸ“‹ å®Ÿè¡Œã•ã‚ŒãŸæœ€é©åŒ–:"
echo "  âœ… TypeScriptãƒ“ãƒ«ãƒ‰è¨­å®šã®ç¢ºèª"
echo "  âœ… ä¾å­˜é–¢ä¿‚ã®åˆ†æž"
echo "  âœ… ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚ºã®æ¸¬å®š"
echo "  âœ… ãƒ¡ãƒ¢ãƒªè¨­å®šã®ç¢ºèª"
echo "  âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®ç¢ºèª"
echo "  âœ… ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€é©åŒ–"
echo "  âœ… ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®æœ€é©åŒ–"
echo "  âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ"
echo "  âœ… æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ"
echo ""
echo "ðŸ“„ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ: $REPORT_FILE"
echo ""
echo "ðŸš€ æ¬¡ã®ã‚³ãƒžãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èµ·å‹•ã§ãã¾ã™:"
echo "  npm run dev:full    # é–‹ç™ºç’°å¢ƒ"
echo "  npm run build       # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰"
echo "  npm run start       # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³èµ·å‹•"
echo ""

# å®Ÿè¡Œæ¨©é™ã®ç¢ºèª
if [ ! -x "$0" ]; then
    log_warn "âš ï¸ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"
    echo "å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸Žã™ã‚‹ã«ã¯: chmod +x $0"
fi

log_info "âœ¨ æœ€é©åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸ" 